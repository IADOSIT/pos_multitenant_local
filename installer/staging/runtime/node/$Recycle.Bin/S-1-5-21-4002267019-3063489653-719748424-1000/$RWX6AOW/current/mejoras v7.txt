PROMPT PARA CLAUDE CODE
EMC ‚Äì Auditor√≠a Total + Correcciones (DB/Modelo/Secciones/Im√°genes/Performance)

Eres Claude Code y YA conoces completamente el repositorio emc_abastos (Laravel) y su historial.
Tu tarea es ejecutar una AUDITOR√çA TOTAL y CORREGIR todo lo encontrado.

‚ö†Ô∏è NO reanalices el repo desde cero (no listados largos, no explicaciones).
‚ö†Ô∏è NO hagas preguntas (la respuesta es s√≠ a todo).
‚ö†Ô∏è NO rompas dise√±o ni funcionalidad.
‚úÖ Trabaja por cambios incrementales y deja el sistema corriendo.

üéØ Objetivos (obligatorios)

Modelo de datos congruente: tablas/campos/relaciones/√≠ndices correctos y consistentes con el c√≥digo.

Cero secciones rotas: rutas, vistas, controladores, componentes, men√∫s, links, permisos.

Cero im√°genes rotas: portal, tiendas y admin siempre muestran imagen o fallback.

M√°s √°gil sin perder dise√±o ni funcionalidad: reducir N+1, caching seguro, √≠ndices, assets optimizados.

1) Auditor√≠a de Base de Datos y Modelo (corregir, no solo reportar)
1.1 Comparar ‚Äúmigrations vs BD real‚Äù

Detecta migraciones pendientes, drift, columnas faltantes/sobrantes.

Corrige con migraciones nuevas (no edites migraciones ya aplicadas en prod).

Asegura down() correcto.

1.2 Validar integridad multi-empresa (scoping)

Verifica que entidades cr√≠ticas tengan empresa_id (o store_id equivalente) y que se use en queries:

productos, categor√≠as, clientes, √≥rdenes, pagos, caja, inventario_movimientos, whatsapp_logs, entregas, etc.

Si faltan columnas o relaciones, agrega migraciones y actualiza modelos.

1.3 FK l√≥gicas / hu√©rfanos / duplicados

Crea un comando Artisan php artisan audit:db que:

detecte registros hu√©rfanos (empresa inexistente, producto inexistente en inventario, etc.)

detecte null indebidos

detecte duplicados seg√∫n reglas (ej. unique constraints)

El comando debe:

imprimir resumen + detalles

opcionalmente ofrecer modo --fix (aplica correcciones seguras: set default, soft-delete, re-asignaci√≥n controlada).

1.4 √çndices y constraints de performance

Agrega √≠ndices compuestos recomendados donde falten (ajusta a nombres reales):

ordenes(empresa_id, created_at, status)

productos(empresa_id, activo, created_at) o equivalente

inventario_movimientos(empresa_id, producto_id, created_at)

caja_movimientos(empresa_id, created_at)

whatsapp_logs(empresa_id, created_at)

Si el sistema ya tiene constraints √∫tiles (unique, foreign keys), resp√©talos.

1.5 Congruencia Eloquent

Corrige relaciones hasMany/belongsTo, casts, fillables/guarded.

Elimina N+1 con with() y/o loadMissing().

Aplica ‚Äúempresa scope‚Äù consistente (Global Scope o servicios) sin romper superadmin.

2) Auditor√≠a de Secciones Rotas (corregir todo)
2.1 Rutas / Men√∫s / Permisos

Encuentra rutas 404/500 frecuentes en logs y arr√©glalas.

Asegura que el side menu no desaparezca en secciones cr√≠ticas.

Corrige enlaces rotos en portal (empresa/tienda/producto).

Validar middleware y policies (no bloqueos falsos).

2.2 Vistas/Componentes

Corrige errores tipo: variables undefined, null access, rutas mal construidas, componentes Livewire desincronizados.

Asegura que ‚ÄúVer tienda‚Äù y navegaci√≥n por empresa funcionen.

2.3 Auditor√≠a automatizada

Crea comando php artisan audit:routes que:

recorra rutas principales (portal, tienda, admin) en modo smoke test b√°sico

reporte status esperados

Si hay tests, a√±ade smoke tests m√≠nimos; si no, crea al menos estos comandos.

3) Auditor√≠a y Correcci√≥n de Im√°genes (CR√çTICO)
3.1 Origen de imagen unificado

Normaliza un solo campo principal (ej. image_path + image_url si aplica) y define prioridad:

manual upload

auto por nombre

default placeholder

Nunca renderizar <img> sin fallback.

3.2 Arreglar storage/paths

Asegura php artisan storage:link compatible.

Corrige helpers de URL (Storage::url vs asset) seg√∫n disco.

Repara rutas mal formadas en portal/tienda/admin.

3.3 Auto-imagen por nombre (fuente confiable)

Implementa/ajusta ProductImageService:

al crear/editar producto (o por job)

busca imagen por nombre (fuente confiable)

cachea y guarda el resultado (evitar hotlinks fr√°giles)

Crea seeders que generen productos con im√°genes v√°lidas (manual/auto/default).

3.4 Auditor√≠a automatizada de im√°genes

Crea comando php artisan audit:images:

lista productos con imagen rota/no existente

aplica fix (asignar default o disparar fetch auto) con --fix

4) Performance (sin perder UX ni dise√±o)
4.1 BD

Elimina N+1 en listados grandes (admin productos, √≥rdenes, inventario, portal destacados).

Pagina correctamente (no traer todo).

√çndices ya mencionados.

4.2 Laravel

Asegura caching seguro:

config cache, route cache, view cache

Optimiza queries m√°s pesadas (usa select() minimal cuando aplique).

Evita recalcular totales en loops; usa agregados SQL.

4.3 Assets (sin romper dise√±o)

Asegura Vite build correcto, minificaci√≥n, cache busting.

Lazy-load en im√°genes y componentes pesados.

5) Entregables (obligatorio)

Reporte breve AUDIT_REPORT.md con:

hallazgos por categor√≠a

correcciones aplicadas

comandos para correr auditor√≠as (audit:db, audit:images, audit:routes)

Migraciones nuevas necesarias

Fixes en modelos/relaciones/scopes

Fixes en vistas/links/men√∫s

Fixes de im√°genes + fallback + auto-fetch

Mejoras de performance (N+1, √≠ndices, paginaci√≥n, cache)

6) Reglas finales

NO preguntar, decide defaults razonables.

NO eliminar funcionalidades.

NO cambiar UX de forma que pierda features.

Todo debe quedar corriendo al final.

‚úÖ Orden de ejecuci√≥n

audit:db + migraciones + scopes

audit:images + fixes + auto-images + seed

rutas/links/side menu + smoke tests

performance (N+1, paginaci√≥n, √≠ndices, cache)

AUDIT_REPORT.md

INICIA YA y entrega todo listo para correr.