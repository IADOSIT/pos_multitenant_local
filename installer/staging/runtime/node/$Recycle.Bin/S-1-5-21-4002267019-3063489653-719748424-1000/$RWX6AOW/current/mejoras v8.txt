PROMPT PARA CLAUDE CODE
EMC ‚Äì Mejoras V7 (Importaciones + Pickup/Delivery + Portal)

Eres Claude Code y YA conoces completamente el repositorio emc_abastos (Laravel) y lo trabajado en V6.
Esta es una NUEVA VERSI√ìN: V7.

‚ö†Ô∏è NO reanalices el repo, NO listes archivos, NO hagas preguntas.
‚úÖ Mant√©n dise√±o y funcionalidad existentes.
‚úÖ Implementa con mejores pr√°cticas, estable y escalable.

üéØ Objetivos V7 (obligatorios)

Importaciones (productos, categor√≠as, clientes, inventarios) con plantilla descargable y carga por empresa(s).

Implementar proceso Pickup / Delivery con estados + notificaciones WhatsApp end-to-end (inicio‚Üífin) incluyendo folio, mercanc√≠a y total.

Quitar secci√≥n de productos del portal y mejorar animaciones/efectos del portal sin perder rendimiento.

1) IMPORTACIONES (Admin) ‚Äì CSV/XLSX + Plantillas
1.1 M√≥dulo ‚ÄúImportaciones‚Äù

Agregar en Admin un m√≥dulo: Importaciones con tabs:

Productos

Categor√≠as

Clientes

Inventarios

1.2 Plantillas descargables (obligatorio)

Para cada entidad:

Bot√≥n ‚ÄúDescargar plantilla‚Äù (CSV y/o XLSX)

Incluye:

encabezados correctos

ejemplos de 1‚Äì3 filas

notas de formato (en segunda hoja si es XLSX o como comentario/documento)

1.3 Carga de archivo (obligatorio)

Bot√≥n ‚ÄúSubir archivo‚Äù

Validaci√≥n previa (preview):

filas totales

v√°lidas / inv√°lidas

errores por fila con motivo

Confirmaci√≥n ‚ÄúImportar‚Äù

1.4 Delimitado por empresa (regla clave)

Si el usuario es admin de 1 empresa ‚Üí se fija esa empresa (no seleccionable).

Si tiene varias empresas ‚Üí selector de empresa(s):

opci√≥n 1 empresa

opci√≥n m√∫ltiples empresas (cuando el formato lo soporte)

Implementar 2 modos:

Modo A (recomendado default): importar a 1 empresa seleccionada (m√°s seguro)

Modo B (opcional): archivo incluye columna empresa_public_id/empresa_slug para importar m√∫ltiples empresas en un mismo archivo (solo superadmin)

1.5 Implementaci√≥n t√©cnica (mejor pr√°ctica)

Usar jobs en cola para imports grandes (no bloquear request):

ImportJob por tipo

Guardar historial:

imports table: tipo, empresa_id(s), usuario_id, archivo, status, counters, started_at/finished_at, error_file

Rollback seguro:

transacciones por chunk

idempotencia (evitar duplicados por SKU/c√≥digo)

Mapeos:

Productos: sku/c√≥digo √∫nico por empresa

Categor√≠as: slug/nombre √∫nico por empresa

Clientes: email/tel√©fono √∫nico por empresa (define prioridad y normaliza)

1.6 Inventarios (importaci√≥n)

Soportar 2 variantes:

Stock inicial (set absoluto)

Ajuste (delta +/‚àí) generando movimiento en kardex/ledger
Default: Ajuste (para trazabilidad), con raz√≥n ‚ÄúImportaci√≥n‚Äù.

2) PICKUP / DELIVERY ‚Äì Proceso + Estados + WhatsApp
2.1 Mejor pr√°ctica de proceso (implementa)

Crear un flujo est√°ndar con estados claros (m√≠nimo viable, escalable):

Estados sugeridos:

RECIBIDO (pedido creado, folio generado)

CONFIRMADO (tienda confirma surtido)

EN_PREPARACION (picking)

LISTO_PARA_PICKUP o LISTO_PARA_ENVIO (seg√∫n tipo)

EN_RUTA (solo delivery)

ENTREGADO o RECOGIDO

CANCELADO (opcional)

INCIDENCIA (opcional)

2.2 Tipo de entrega

En checkout/pedido:

fulfillment_type: pickup | delivery
Si delivery:

direcci√≥n obligatoria

ventana/horario (si existe)
Si pickup:

instrucciones de recolecci√≥n

2.3 WhatsApp end-to-end (obligatorio)

Cada cambio de estado relevante dispara notificaci√≥n WhatsApp al cliente incluyendo:

Folio

Estatus

Mercanc√≠a (resumen: 3‚Äì5 items + ‚Äúy N m√°s‚Äù)

Total

CTA seg√∫n estado (ej. ‚ÄúSeguimiento‚Äù, ‚ÄúConfirmar recepci√≥n‚Äù, etc.)

Reutiliza el m√≥dulo WhatsApp existente (logs, retry, resend).
Asegura:

idempotencia (no duplicar mensajes)

logs por pedido/estado

reintentos autom√°ticos/manuales

2.4 Implementaci√≥n t√©cnica (mejor pr√°ctica)

Evento OrderStatusChanged

Listener SendOrderWhatsAppNotification

Plantillas de mensaje configurables por empresa (si ya hay temas/plantillas, integrar ah√≠)

Respetar reglas de ‚Äúno enviar‚Äù si falta tel√©fono o cliente opt-out (log skipped_reason)

3) PORTAL ‚Äì Quitar productos + mejorar animaci√≥n/efectos
3.1 Quitar secci√≥n de productos del portal

El portal NO debe listar productos (ni grid general).

Mantener √∫nicamente:

promociones/destacados por tienda (si aplica)

contenido marketing / directorio de tiendas / EMC

Eliminar links/men√∫ ‚ÄúProductos‚Äù del portal y cualquier ruta asociada.

3.2 Animaciones y efectos (mejora)

Mejorar animaci√≥n general del portal y hero (ligero):

fade/slide

hover microinteractions

‚Äúflash‚Äù en destacados si existe (respetar configuraci√≥n de color)

Performance:

lazy-load

evitar librer√≠as pesadas

mantener responsive y accesible

üì¶ Entregables V7

Admin ‚Üí Importaciones (4 tabs) + plantillas descargables + preview + ejecuci√≥n + historial

Importaci√≥n delimitada por empresa (selector y/o columna empresa para superadmin)

Import inventarios con ajuste v√≠a ledger/kardex

Flujo Pickup/Delivery con estados + UI m√≠nima

WhatsApp notificaciones por estatus (inicio‚Üífin) con folio, mercanc√≠a y total

Portal sin secci√≥n de productos + animaciones/efectos mejorados sin perder rendimiento

Documentaci√≥n breve V7_IMPORTS_AND_FULFILLMENT.md con:

formato plantillas

estados

c√≥mo probar WhatsApp en dev

‚úÖ Orden de ejecuci√≥n (sin preguntar)

Importaciones (tablas + UI + templates + jobs + historial)

Inventarios import (ajuste ledger)

Fulfillment pickup/delivery + estados

Eventos/listeners WhatsApp por estatus

Portal: remover productos + polish animaciones